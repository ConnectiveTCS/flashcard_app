<!DOCTYPE html>
<html>
<head>
    <title>Flashcards</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-200 to-purple-300 min-h-screen flex flex-col items-center justify-center overflow-x-hidden px-4 sm:px-0">
    <h1 class="text-4xl font-bold mb-8 text-gray-800 drop-shadow-lg">Flashcard Quiz</h1>
    <div id="flashcard-container" class="w-full max-w-4xl flex flex-col items-center">
        <div id="card" class="relative w-full sm:w-11/12 md:w-4/5 lg:w-3/4 h-[50vh] sm:h-[36.5rem] perspective mb-6">
            <!-- Card inner -->
            <div id="card-inner" class="transition-transform duration-500 w-full h-full cursor-pointer" onclick="flipCard()">
                <div id="card-front" class="absolute w-full h-full bg-white rounded-xl shadow-xl flex items-center justify-center text-2xl font-semibold text-gray-800 backface-hidden p-6">
                    <!-- Question will be injected here -->
                </div>
                <div id="card-back" class="absolute w-full h-full bg-indigo-500 rounded-xl shadow-xl flex items-center justify-center text-2xl font-semibold text-white backface-hidden p-6 rotate-y-180">
                    <!-- Answer will be injected here -->
                </div>
            </div>
        </div>
        <div class="flex flex-wrap justify-center gap-3 mb-4">
            <button onclick="prevCard()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded shadow text-gray-700 font-semibold">Previous</button>
            <button onclick="nextCard()" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 rounded shadow text-white font-semibold">Next</button>
            <button onclick="toggleBookmark()" class="px-4 py-2 bg-yellow-400 hover:bg-yellow-500 rounded shadow text-gray-800 font-semibold">
                Bookmark
            </button>
            <button onclick="markCorrect()" class="px-4 py-2 bg-green-400 hover:bg-green-500 rounded shadow text-white font-semibold">
                Correct
            </button>
            <button onclick="markIncorrect()" class="px-4 py-2 bg-red-400 hover:bg-red-500 rounded shadow text-white font-semibold">
                Incorrect
            </button>
        </div>
        <div class="w-full sm:w-1/2 mb-4">
            <label for="module-filter" class="text-gray-700 font-medium mb-2">Filter by Module:</label>
            <select id="module-filter" onchange="applyFilter()" class="px-3 py-1 rounded border">
                <option value="all">All</option>
                <!-- module options injected by JS -->
            </select>
        </div>
        <div id="index-container" class="w-full max-h-48 overflow-y-auto bg-white bg-opacity-50 rounded-lg p-2 shadow-inner">
            <!-- index listing injected by JS -->
        </div>
        <div id="card-counter" class="mt-4 text-gray-600 font-medium"></div>
    </div>
    <script>
        const flashcards = {{ flashcards|tojson|safe }};
        let current = 0;
        let flipped = false;

        // initialize bookmark & correct state
        flashcards.forEach(c => { c.bookmarked = false; c.correct = null; });
        let filteredFlashcards = flashcards.slice();

        function renderCard() {
            const card = flashcards[current];
            document.getElementById('card-front').textContent = card.question;
            document.getElementById('card-back').textContent = card.answer;
            document.getElementById('card-counter').textContent = `Card ${current + 1} of ${flashcards.length}`;
            // Reset flip
            document.getElementById('card-inner').style.transform = 'rotateY(0deg)';
            flipped = false;
            // update bookmark button text
            document.querySelector('button[onclick="toggleBookmark()"]').textContent =
                flashcards[current].bookmarked ? 'Unbookmark' : 'Bookmark';
        }

        function flipCard() {
            const cardInner = document.getElementById('card-inner');
            if (!flipped) {
                cardInner.style.transform = 'rotateY(180deg)';
                flipped = true;
            } else {
                cardInner.style.transform = 'rotateY(0deg)';
                flipped = false;
            }
        }

        function nextCard() {
            if (current < flashcards.length - 1) {
                current++;
                renderCard();
            }
        }

        function prevCard() {
            if (current > 0) {
                current--;
                renderCard();
            }
        }

        function toggleBookmark() {
            flashcards[current].bookmarked = !flashcards[current].bookmarked;
            renderIndex();
            renderCard();
        }

        function markCorrect() {
            flashcards[current].correct = true;
            renderIndex();
        }

        function markIncorrect() {
            flashcards[current].correct = false;
            renderIndex();
        }

        function goToCard(idx) {
            current = flashcards.indexOf(filteredFlashcards[idx]);
            renderCard();
        }

        function renderIndex() {
            const container = document.getElementById('index-container');
            const modules = {};
            filteredFlashcards.forEach((card, i) => {
                const mod = card.module || 'Uncategorized';
                (modules[mod] = modules[mod]||[]).push({ i, card });
            });
            let html = '';
            for (const [mod, items] of Object.entries(modules)) {
                html += `<div class="mb-2"><h3 class="font-bold">${mod}</h3><ul class="list-disc pl-5">`;
                items.forEach(({ i, card }) => {
                    const star   = card.bookmarked ? '⭐' : '';
                    const status = card.correct===true ? '✔️' : card.correct===false ? '❌' : '';
                    const global = flashcards.indexOf(filteredFlashcards[i]) + 1;
                    html += `<li class="cursor-pointer py-1 px-2 rounded hover:bg-gray-100" onclick="goToCard(${i})">Card ${global} ${star} ${status}</li>`;
                });
                html += '</ul></div>';
            }
            container.innerHTML = html;
        }

        function applyFilter() {
            const sel = document.getElementById('module-filter').value;
            filteredFlashcards = sel === 'all'
                ? flashcards
                : flashcards.filter(c => (c.module||'Uncategorized')===sel);
            current = 0;
            renderCard();
            renderIndex();
        }

        // populate filter dropdown and initial index
        new Set(flashcards.map(c=>c.module||'Uncategorized')).forEach(mod => {
            document.getElementById('module-filter')
                .insertAdjacentHTML('beforeend', `<option value="${mod}">${mod}</option>`);
        });
        renderIndex();

        // Tailwind custom class for 3D flip
        document.head.insertAdjacentHTML('beforeend', `<style>
            .perspective { perspective: 1000px; }
            #card-inner { 
                transition: transform 0.5s; 
                transform-style: preserve-3d;
            }
            .backface-hidden {
                backface-visibility: hidden;
            }
            .rotate-y-180 {
                transform: rotateY(180deg);
            }
        </style>`);

        // Initial render
        renderCard();
    </script>
</body>
</html>
