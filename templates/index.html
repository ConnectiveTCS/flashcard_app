<!DOCTYPE html>
<html>
  <head>
    <title>Flashcards</title>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css"
      rel="stylesheet"
    />
  </head>

  <body
    class="bg-gradient-to-br from-blue-200 to-purple-300 max-h-screen min-h-screen flex flex-row items-center justify-center overflow-x-hidden px-4 sm:px-0 overflow-y-clip md:overflow-y-hidden"
  >
    <div class="text-center">
      <button
        class="absolute top-4 left-4 text-white bg-black hover:bg-gray-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2 dark:bg-blue-600 dark:hover:bg-black focus:outline-none dark:focus:ring-blue-800"
        type="button"
        data-drawer-target="drawer-example"
        data-drawer-show="drawer-example"
        aria-controls="drawer-example"
      >
        Index
      </button>
    </div>
    <div
      id="drawer-example"
      class="fixed top-0 left-0 z-40 h-screen p-4 overflow-y-auto transition-transform -translate-x-full bg-white w-80 dark:bg-gray-800"
      tabindex="-1"
      aria-labelledby="drawer-label"
    >
      <div class="w-full sm:w-1/2 mb-4">
        <label for="module-filter" class="text-gray-700 font-medium mb-2"
          >Filter by Module:</label
        >
        <select
          id="module-filter"
          onchange="applyFilter()"
          class="px-3 py-1 rounded border"
        >
          <option value="all">All</option>
          <!-- module options injected by JS -->
        </select>
      </div>
      <div
        id="index-container"
        class="w-full max-h-full overflow-y-auto bg-white bg-opacity-50 rounded-lg p-2 shadow-inner"
      >
        <!-- index listing injected by JS -->
      </div>
    </div>
    <div class="flex-1 bg-opacity-80 rounded-lgp-6">
      <div id="flashcard-container" class="w-full flex flex-col items-center">
        <div
          id="card"
          class="relative w-full sm:w-11/12 md:w-4/5 lg:w-3/4 h-[50vh] sm:h-[36.5rem] perspective mb-6"
        >
          <!-- Card inner -->
          <div
            id="card-inner"
            class="transition-transform duration-500 w-full h-full cursor-pointer"
            onclick="flipCard()"
          >
            <div
              id="card-front"
              class="absolute w-full h-full bg-white rounded-xl shadow-xl flex items-center justify-center text-2xl font-semibold text-gray-800 backface-hidden p-6"
            >
              <!-- Question will be injected here -->
            </div>
            <div
              id="card-back"
              class="absolute w-full h-full bg-indigo-500 rounded-xl shadow-xl flex flex-col items-start justify-center text-2xl font-semibold text-white backface-hidden p-6 rotate-y-180"
            >
              <!-- Answer will be injected here -->
            </div>
          </div>
        </div>
        <div class="text-center fixed left-2 right-2 bottom-2">
          <button
            onclick="prevCard()"
            class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded shadow text-gray-700 font-semibold"
          >
            Previous
          </button>
          <button
            onclick="nextCard()"
            class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 rounded shadow text-white font-semibold"
          >
            Next
          </button>
          <button
            class="px-4 py-2 bg-black hover:bg-gray-700 rounded shadow text-white font-semibold"
            type="button"
            data-drawer-target="controls-example"
            data-drawer-show="controls-example"
            aria-controls="controls-example"
          >
            Controls
          </button>
        </div>
        <div
          id="controls-example"
          class="sticky text-center bottom-0 left-0 z-40 p-4 justify-center overflow-y-auto transition-transform -translate-x-full bg-white w-full dark:bg-gray-800"
          tabindex="-1"
          aria-labelledby="drawer-label"
        >
          <button
            onclick="toggleBookmark()"
            class="px-4 py-2 bg-yellow-400 hover:bg-yellow-500 rounded shadow text-gray-800 font-semibold"
          >
            Bookmark
          </button>
          <button
            onclick="markCorrect()"
            class="px-4 py-2 bg-green-400 hover:bg-green-500 rounded shadow text-white font-semibold"
          >
            Correct
          </button>
          <button
            onclick="markIncorrect()"
            class="px-4 py-2 bg-red-400 hover:bg-red-500 rounded shadow text-white font-semibold"
          >
            Incorrect
          </button>
          <button
            onclick="toggleFullscreen()"
            class="px-4 py-2 bg-blue-400 hover:bg-blue-500 rounded shadow text-white font-semibold"
          >
            Fullscreen
          </button>
        </div>
      </div>
    </div>
    <script>
      // ...existing functions...

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }

      // ...initial render etc...
    </script>
    
    <script>
        const flashcards = {{ flashcards| tojson | safe }};
        let current = 0;
        let flipped = false;

        // load persisted statuses and initialize state
        const statuses = JSON.parse(localStorage.getItem('flashcardStatuses') || '{}');
        flashcards.forEach(c => {
          const s = statuses[c.question] || {};
          c.bookmarked = s.bookmarked || false;
          c.correct   = s.correct   !== undefined ? s.correct : null;
        });

        let filteredFlashcards = flashcards.slice();

  function renderCard() {
    const card = flashcards[current];
    document.getElementById('card-front').textContent = card.question;

    // split on newlines and wrap each in <p>, then insert an extra <br> between them
    const htmlAnswer = card.answer
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length)
      .map(line => `<p>${line}</p>`)
      .join('<br>');

    document.getElementById('card-back').innerHTML = htmlAnswer;

    document.getElementById('card-counter').textContent =
      `Card ${current + 1} of ${flashcards.length}`;
    document.getElementById('card-inner').style.transform = 'rotateY(0deg)';
    flipped = false;
    document.querySelector('button[onclick="toggleBookmark()"]').textContent =
      card.bookmarked ? 'Unbookmark' : 'Bookmark';
  }

        function flipCard() {
            const cardInner = document.getElementById('card-inner');
            if (!flipped) {
                cardInner.style.transform = 'rotateY(180deg)';
                flipped = true;
            } else {
                cardInner.style.transform = 'rotateY(0deg)';
                flipped = false;
            }
        }

        function nextCard() {
            if (current < flashcards.length - 1) {
                current++;
                renderCard();
            }
        }

        function prevCard() {
            if (current > 0) {
                current--;
                renderCard();
            }
        }

        function toggleBookmark() {
            flashcards[current].bookmarked = !flashcards[current].bookmarked;
            // persist change
            statuses[flashcards[current].question] = {
              bookmarked: flashcards[current].bookmarked,
              correct:    flashcards[current].correct
            };
            localStorage.setItem('flashcardStatuses', JSON.stringify(statuses));
            renderIndex();
            renderCard();
        }

        function markCorrect() {
            flashcards[current].correct = true;
            // persist change
            statuses[flashcards[current].question] = {
              bookmarked: flashcards[current].bookmarked,
              correct:    true
            };
            localStorage.setItem('flashcardStatuses', JSON.stringify(statuses));
            renderIndex();
        }

        function markIncorrect() {
            flashcards[current].correct = false;
            // persist change
            statuses[flashcards[current].question] = {
              bookmarked: flashcards[current].bookmarked,
              correct:    false
            };
            localStorage.setItem('flashcardStatuses', JSON.stringify(statuses));
            renderIndex();
        }

        function goToCard(idx) {
            current = flashcards.indexOf(filteredFlashcards[idx]);
            renderCard();
        }

        function renderIndex() {
            const container = document.getElementById('index-container');
            const modules = {};
            filteredFlashcards.forEach((card, i) => {
                const mod = card.module || 'Uncategorized';
                (modules[mod] = modules[mod] || []).push({ i, card });
            });
            let html = '';
            for (const [mod, items] of Object.entries(modules)) {
                html += `<div class="mb-2"><h3 class="font-bold">${mod}</h3><ul class="list-disc pl-5">`;
                items.forEach(({ i, card }) => {
                    const star = card.bookmarked ? '⭐' : '';
                    const status = card.correct === true ? '✔️' : card.correct === false ? '❌' : '';
                    const global = flashcards.indexOf(filteredFlashcards[i]) + 1;
                    html += `<li class="cursor-pointer py-1 px-2 rounded hover:bg-gray-100" onclick="goToCard(${i})">Card ${global} ${star} ${status}</li>`;
                });
                html += '</ul></div>';
            }
            container.innerHTML = html;
        }

        function applyFilter() {
            const sel = document.getElementById('module-filter').value;
            filteredFlashcards = sel === 'all'
                ? flashcards
                : flashcards.filter(c => (c.module || 'Uncategorized') === sel);
                //add more filter categories as needed
            current = 0;
            renderCard();
            renderIndex();
        }

        // populate filter dropdown and initial index
        new Set(flashcards.map(c => c.module || 'Uncategorized')).forEach(mod => {
            document.getElementById('module-filter')
                .insertAdjacentHTML('beforeend', `<option value="${mod}">${mod}</option>`);
        });
        renderIndex();

        // Tailwind custom class for 3D flip
        document.head.insertAdjacentHTML('beforeend', `<style>
          .perspective { perspective: 1000px; }
          #card-inner {
              transition: transform 0.5s;
              transform-style: preserve-3d;
          }
          .backface-hidden {
              backface-visibility: hidden;
          }
          .rotate-y-180 {
              transform: rotateY(180deg);
          }
      </style>`);

        // Initial render
        renderCard();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
  </body>
</html>
